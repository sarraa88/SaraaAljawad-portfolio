---
title: "CDC Data Exercise"
format: html
---


## Introduction

This analysis uses publicly available data from the Centers for Disease Control and Prevention (CDC)
to explore the prevalence of post-COVID conditions (long COVID) among adults in the United States.


```{r}
library(tidyverse)
library(janitor)
library(here)

# Read CDC data
raw <- read_csv(here("cdcdata-exercise", "Post-COVID_Conditions_20260206.csv"))

# Inspect structure
glimpse(raw)

```


## Data Description

The dataset contains survey-based estimates from the CDC household Survey that describe the prevalence of post-COVID conditions (long COVID) among adults aged 18 and older in the United States.Each row in the dataset represents a population-level estimate for a specific
group and time period. The main variables used in this analysis include the type
of long COVID indicator being measured, population group and subgroup categories,
the time period of data collection, and the estimated percentage value.

## Data Cleaning

```{r}
# Clean column names
data_clean <- raw %>%
  clean_names()

# Select relevant variables
cdc_data <- data_clean %>%
  select(
    indicator,
    group,
    subgroup,
    time_period_label,
    value
  )

# Inspect cleaned dataset
glimpse(cdc_data)

```


## Exploratory Data Analysis

*Exploring the distribution and overall structure of the data* 
```{r}
# Summary statistics for the continuous variable
cdc_data %>%
  summarize(
    mean_value = mean(value, na.rm = TRUE),
    sd_value   = sd(value, na.rm = TRUE),
    min_value  = min(value, na.rm = TRUE),
    max_value  = max(value, na.rm = TRUE)
  )

```

```{r}
# Frequency table for indicator
indicator_freq <- cdc_data %>%
  count(indicator) %>%
  mutate(percent = n / sum(n) * 100)

```

## Visualization of the data 

```{r}
# Histogram of percentage estimates
ggplot(cdc_data, aes(x = value)) +
  geom_histogram(bins = 30) +
  labs(
    title = "Distribution of Post-COVID Percentage Estimates",
    x = "Percentage Value",
    y = "Count"
  )

```


*The histogram shows the distribution of estimated percentages of adults experiencing post-COVID conditions across different population groups and time periods. Most estimates are concentrated below 30%, indicating that reported prevalence of long COVID is generally low to moderate for most groups. Higher percentage values occur less frequently and represent specific subgroups with elevated reported prevalence.*


```{r}
# Percentage distribution of groups
cdc_data %>%
  count(group) %>%
  mutate(percent = round(n / sum(n) * 100, 1))

```

```{r}
# Bar plot for categorical variable
ggplot(cdc_data, aes(x = group)) +
  geom_bar() +
  labs(
    title = "Distribution of CDC Estimate Groups",
    x = "Group",
    y = "Count"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```



*It has been seen that most observations in the dataset come from state-level estimates, which account for over half of all records. Other estimates are distributed across demographic groupings such as age, race/ethnicity, education, and sex. National-level estimates represent a smaller proportion of the data, reflecting the CDC’s emphasis on reporting subgroup-specific prevalence estimates.*


## *Explore and visualize Post-COVID prevalence* 

### *(a) by age group*

Age in this dataset is reported as categorical age groups rather than as individual ages. The CDC defines these groups as 18–29, 30–49, 50–64, and 65 years and older

```{r}
age_data <- cdc_data %>%
  filter(group == "By Age")

```

```{r}
age_summary <- age_data %>%
  group_by(subgroup) %>%
  summarize(
    mean_value = mean(value, na.rm = TRUE)
  )
age_summary

```

```{r}
ggplot(age_summary,
       aes(x = reorder(subgroup, mean_value),
           y = mean_value)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Average Post-COVID Percentage by Age Group",
    x = "Age group",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal()

```

This summarizes CDC-reported post-COVID condition percentages across age groups. The visualization highlights which age groups tend to report higher or lower post-COVID prevalence.

### *(b) by state*

```{r}
state_data <- cdc_data %>%
  filter(group == "By State")

```


```{r}
state_summary <- state_data %>%
  group_by(subgroup) %>%   # subgroup = state name
  summarize(
    mean_value = mean(value, na.rm = TRUE)
  )

state_summary

```


```{r}
state_top_bottom <- state_summary %>%
  arrange(mean_value) %>%
  slice(c(1:5, (n()-4):n()))

state_top_bottom

```

```{r}
ggplot(state_top_bottom,
       aes(x = reorder(subgroup, mean_value),
           y = mean_value)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Average Post-COVID Percentage by State (Lowest and Highest)",
    x = "State",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal()

```

State-level post-COVID percentages were summarized in this plot by averaging CDC-reported estimates across time periods. The visualization highlights relative differences in reported post-COVID prevalence among states.

### *(c) by sex*

```{r}
sex_data <- cdc_data %>%
  filter(group == "By Sex")

sex_summary <- sex_data %>%
  group_by(subgroup) %>%
  summarize(
    mean_value = mean(value, na.rm = TRUE)
  )

sex_summary

```

```{r}
ggplot(sex_summary,
       aes(x = reorder(subgroup, mean_value),
           y = mean_value,
           fill = subgroup)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Average Reported Post-COVID Percentage by Sex",
    x = "Sex",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal() +
  guides(fill = "none")

```

*This figure compares average CDC-reported post-COVID condition percentages by sex. Females report a higher average post-COVID percentage than males.*

## Notes for Synthetic Data Generation

To create synthetic data with a similar structure, the key variable to mimic is `value` which represents the percentage of adults reporting post-COVID conditions. These percentage values ranges from 0 to about 93 with most values below 30. The synthetic data should also include the same categorical columns (such as `group`, `indicator`, and `subgroup`) and use similar proportions (for example, many rows should be state-level estimates, and fewer rows should be national or demographic estimates). In addition, the synthetic data should include survey `time periods` so that the overall structure matches the original dataset.

# This section contributed by Joe Dainis
```{r}
## Load Required Packages
library(here)
library(dplyr)
library(ggplot2)
library(skimr)
library(gtsummary)

## Set Seed for Reproducibility
set.seed(456)

## Define the number of COVID-19 survey responders
n_COVID <- 18638

## Create an empty dataframe with the 5 variables from COVID-19 survey dataset

syn_dat <- data.frame(
  Indicator = character(n_COVID),
  Group = character(n_COVID),
  TimePeriodLabel = character(n_COVID),
  Value = numeric(n_COVID)
)

## Variable 1: Indicator

syn_dat$Indicator <- sample(c("Any activity limitations from long COVID, as a percentage of adults who currently have long COVID", "Any activity limitations from long COVID, as a percentage of all adults", "Currently experiencing long COVID, as a percentage of adults who ever had COVID", "Currently experiencing long COVID, as a percentage of all adults", "Ever experienced long COVID, as a percentage of adults who ever had COVID", "Ever experienced long COVID, as a percentage of all adults", "Ever had COVID", "Significant activity limitations from long COVID, as a percentage of adults who currently have long COVID", "Significant activity limitations from long COVID, as a percentage of all adults"),
                          n_COVID, replace = TRUE, prob = as.numeric(indicator_freq$percent)/100)

## Variable 2: Group
syn_dat$Group <- sample(c("By Age", "By Disability Status", "By Education", "By Gender identity", "By Race/Hispanic ethnicity", "By Sex", "By Sexual orientation", "By State", "National Estimate"), 
                         n_COVID, replace = TRUE, 
                         prob = as.numeric(table(data_clean$group)/100))


## Variable 3: Time Period Label
target_column <- "time_period_label"

time_probs <- prop.table(table(data_clean[[target_column]], useNA = "no"))

syn_dat$TimePeriodLabel <- sample(
  x = as.character(names(time_probs)), # Ensure this isn't NULL/Empty
  size = n_COVID,
  replace = TRUE,
  prob = as.numeric(time_probs)
)

## Variable 4: Value with Dependencies 

library(dplyr)
library(purrr)

# Split the original data into a list of dataframes based on 'group'
## This creates a 'library' where each drawer only has one group's data
source_list <- split(data_clean, data_clean$group)

# Use group_split on syn_dat to process each group separately
syn_dat <- syn_dat %>%
  group_split(Group) %>%
  map_dfr(function(sub_df) {
    # Identify which group we are currently processing
    current_group <- unique(sub_df$Group)
    
    # Check if this group actually exists in our source data
    if (current_group %in% names(source_list)) {
      pool <- source_list[[current_group]]
      
      # Sample indices equal to the number of rows needed for this group
      sampled_rows <- sample(seq_len(nrow(pool)), size = nrow(sub_df), replace = TRUE)
      
      # Fill the Subgroup and Value columns from the matched pool
      sub_df$Subgroup_Age_Sex_State <- pool$subgroup[sampled_rows]
      sub_df$Value <- pool$value[sampled_rows]
    }
    
    return(sub_df)
  })

#It took me a LONG while to figure this out due to the complexity of the data. I used Gemini AI to help me figure this out. Too many dependencies with all of them being in one column... ... ... Data structure matters a ton! I ended up needing to split the data first, as the subgroup column had SO MANY different categories (sex, age range, sexuality, state, etc etc.) Then, to add in the dependencies based on how the groupings were split, which allowed for the synthetic data to show the necessary depencies for the COVID values on these variables. All of the other variables were straight forward.

view(syn_dat)

#Joe Summaries of Variables and Data

#Visualization of Percentage Values from synthetic data by histogram
ggplot(syn_dat, aes(x = Value)) +
  geom_histogram(bins = 30) +
  labs(
    title = "Distribution of Post-COVID Synthetic Percentage Estimates",
    x = "Percentage Values",
    y = "Count"
  )

#Look at distribution of synthetic data from groups
##Percentage distribution of groups
syn_dat %>%
  count(Group) %>%
  mutate(percent = round(n / sum(n) * 100, 1))

##Bar plot for group data
ggplot(syn_dat, aes(x = Group)) +
  geom_bar() +
  labs (
    title = "Distribution of synthetic CDC estimated groups",
    x = "Group",
    y = "Count"
  ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Looking at the synthetic age data
##Group the synthetic data by age
Joe_age_data <- syn_dat %>%
  filter(Group == "By Age")

##Summarize the mean values for age ranges
Joe_age_summary <- Joe_age_data %>%
  group_by(Subgroup_Age_Sex_State) %>%
  summarize(
    mean_value_age = mean(Value, na.rm = TRUE)
  )
Joe_age_summary

##Create a plot of age range and reported COVID prevalence
ggplot(Joe_age_summary,
       aes(x = reorder(Subgroup_Age_Sex_State, mean_value_age),
           y = mean_value_age)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Average Post-COVID Percentage by Age Group",
    x = "Age group",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal()

#Looking at the synthetic state data
##Group the synthetic data by state
Joe_state_data <- syn_dat %>%
  filter(Group == "By State")

##Summarize the mean values for age ranges
Joe_state_summary <- Joe_state_data %>%
  group_by(Subgroup_Age_Sex_State) %>%
  summarize(
    mean_value_state = mean(Value, na.rm = TRUE)
  )
Joe_state_summary

##Create a plot of state and reported COVID prevalence
state_top_bottom_Joe <- Joe_state_summary %>%
  arrange(mean_value_state) %>%
  slice(c(1:5, (n()-4):n()))

state_top_bottom_Joe

ggplot(state_top_bottom_Joe,
       aes(x = reorder(Subgroup_Age_Sex_State, mean_value_state),
           y = mean_value_state)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Average Post-COVID Percentage by State",
    x = "State",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal()

#Looking at the synthetic age data
##Group the synthetic data by sex
Joe_sex_data <- syn_dat %>%
  filter(Group == "By Sex")

##Summarize the mean values for age ranges
Joe_sex_summary <- Joe_sex_data %>%
  group_by(Subgroup_Age_Sex_State) %>%
  summarize(
    mean_value_sex = mean(Value, na.rm = TRUE)
  )
Joe_sex_summary

##Create a plot of age range and reported COVID prevalence
ggplot(Joe_sex_summary,
       aes(x = reorder(Subgroup_Age_Sex_State, mean_value_sex),
           y = mean_value_sex,
           fill = Subgroup_Age_Sex_State)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("Female" = "red", "Male" = "blue")) +
  labs(
    title = "Average Post-COVID Percentage by Sex",
    x = "Sex",
    y = "Average reported percentage (%)"
  ) +
  theme_minimal() +
  guides(fill = "none")

#It looks like my synthetic data is close to the original!
```

